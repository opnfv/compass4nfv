---
#- hosts: config
#  sudo: yes
#  tasks:
- name: "start supervisor support service"
#  sudo: True
  service:
    name: "supervisor-support-service"
    state: "started"



- name: "stop rabbitmq server via supervisor"
#  sudo: True
  supervisorctl:
    name: "rabbitmq-server"
    state: "stopped"
    server_url: "unix:///tmp/supervisord_support_service.sock"



- name: "-rabbitmq-stop"
#  sudo: True
  include: -rabbitmq-stop.yml



- name: "update hosts"
#  sudo: True
  lineinfile:
    dest: "/etc/hosts"
#    line: "{{ hostvars[item]['contrail_address'] }}\t{{ hostvars[item]['ansible_hostname'] }} {{ hostvars[item]['ansible_hostname'] }}-ctrl"
    line: "{{ contrail_address }}\t{{ inventory_hostname }} {{ inventory_hostname }}-ctrl"
  with_items: groups['opencontrail_config']



- name: "fix up rabbitmq env"
#  sudo: True
  template:
    src: "provision/rabbitmq-env-conf.j2"
    dest: "/etc/rabbitmq/rabbitmq-env.conf"



- name: "fix up rabbitmq config for single node"
#  sudo: True
  template:
    src: "provision/rabbitmq-conf-single.j2"
    dest: "/etc/rabbitmq/rabbitmq.config"
  when: groups['opencontrail_config'][1] is not defined



- name: fix up rabbitmq config for multi nodes
#  sudo: True
  template:
    src: "provision/rabbitmq-conf.j2"
    dest: "/etc/rabbitmq/rabbitmq.config"
  when: groups['opencontrail_config'][1] is defined



- name: "-rabbitmq-stop"
#  sudo: True
  include: -rabbitmq-stop.yml
  
  

- name: "create cookie uuid temporary"
#  sudo: True
  local_action:
    module: "template"
    src: "provision/rabbitmq-cookie.j2"
    dest: "/tmp/tmp-rabbitmq-cookie"
  run_once: yes


- name: "update cookie uuid"
#  sudo: True
  copy:
    src: "/tmp/tmp-rabbitmq-cookie"
    dest: "/var/lib/rabbitmq/.erlang.cookie"
    owner: "rabbitmq"
    group: "rabbitmq"
    mode: 0400



- name: "delete temporary cookie uuid"
#  sudo: True
  local_action:
    module: "file"
    dest: "/tmp/tmp-rabbitmq-cookie"
    state: "absent"
  run_once: yes



- name: "start rabbitmq server"
#  sudo: True
  service:
    name: "rabbitmq-server"
    state: "started"
