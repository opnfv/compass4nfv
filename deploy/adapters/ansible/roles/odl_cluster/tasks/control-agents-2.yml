---

- name: set opendaylight as the manager
  command: |
    su -s /bin/sh -c "ovs-vsctl set-manager tcp:{{ internal_lb_vip_address }}:6640;"

- name: check br-int
  shell: |
    ovs-vsctl list-br | grep br-int; while [ $? -ne 0 ]; do sleep 10; \
        ovs-vsctl list-br | grep br-int; done

- name: set local ip in openvswitch
  shell: |
    ovs-vsctl set Open_vSwitch $(ovs-vsctl show | head -n 1) \
        other_config={'local_ip'=' {{ hostvars[inventory_hostname]['container_networks']['tunnel_address']['address'] }} '};
  when: inventory_hostname not in groups['nova_compute']

- name: set local ip in openvswitch
  shell: |
    ovs-vsctl set Open_vSwitch $(ovs-vsctl show | head -n 1) \
        other_config={'local_ip'=' {{ hostvars[inventory_hostname]['ansible_br_vxlan']['ipv4']['address'] }} '};
  when: inventory_hostname in groups['nova_compute']

- name: Setup br-provider
  openvswitch_bridge:
    bridge: br-provider
    state: present
  when: inventory_hostname not in groups['nova_compute']
#  notify:
#    - Restart neutron-openvswitch-agent

- name: add ovs uplink
  openvswitch_port:
    bridge: br-provider
    port: "eth12"
    state: present
  when:
    - inventory_hostname not in groups['nova_compute']
#  notify:
#    - Restart neutron-openvswitch-agent

- name: set external nic in openvswitch
  shell: |
    ovs-vsctl set Open_vSwitch $(ovs-vsctl show | head -n 1) \
        other_config:provider_mappings=physnet:br-provider
  when: odl_l3_agent == "Enable"
