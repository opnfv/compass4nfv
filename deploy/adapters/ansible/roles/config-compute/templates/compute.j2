# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# Physical interface
auto eth0
iface eth0 inet manual

# external interface
{% set intf_external = sys_intf_mappings["external"]["interface"] %}
{% if sys_intf_mappings["external"]["vlan_tag"] != "None" %}
{% set intf_external = intf_external + '.' + sys_intf_mappings["external"]["vlan_tag"]|string %}
{% endif %}
auto {{ intf_external }}
iface {{ intf_external }} inet manual
{% if sys_intf_mappings["external"]["vlan_tag"] != "None" %}
    vlan-raw-device {{ intf_external }}
{% endif %}

# tenant interface
{% set intf_tenant = sys_intf_mappings["tenant"]["interface"] %}
{% if sys_intf_mappings["tenant"]["interface"] != "None" %}
{% set intf_tenant = intf_tenant + '.' + sys_intf_mappings["tenant"]["vlan_tag"]|string %}
{% endif %}
auto {{ intf_tenant }}
iface {{ intf_tenant }} inet manual
{% if sys_intf_mappings["tenant"]["interface"] != "None" %}
    vlan-raw-device {{ intf_tenant }}
{% endif %}

# storage interface
{% set intf_storage = sys_intf_mappings["storage"]["interface"] %}
{% if sys_intf_mappings["storage"]["interface"] != "None" %}
{% set intf_storage = intf_storage + '.' + sys_intf_mappings["storage"]["vlan_tag"]|string %}
{% endif %}
auto {{ intf_storage }}
iface {{ intf_storage }} inet manual
{% if sys_intf_mappings["storage"]["interface"] != "None" %}
    vlan-raw-device {{ intf_storage }}
{% endif %}

# Container/Host management bridge
auto br-mgmt
iface br-mgmt inet static
    bridge_stp off
    bridge_waitport 0
    bridge_fd 0
    bridge_ports eth0
    address {{ host_info[inventory_hostname].MGMT_IP }}
    netmask 255.255.255.0

# OpenStack Networking VLAN bridge
auto br-external
iface br-external inet static
    bridge_stp off
    bridge_waitport 0
    bridge_fd 0
    bridge_ports {{ intf_external }}
    address {{ ip_settings[inventory_hostname]["external"]["ip"] }}
    netmask 255.255.255.0
    gateway {{ ip_settings[inventory_hostname]["external"]["gw"] }}
    offload-sg off
    # Create veth pair, don't bomb if already exists
    pre-up ip link add br-vlan-veth type veth peer name eth12 || true
    # Set both ends UP
    pre-up ip link set br-vlan-veth up
    pre-up ip link set eth12 up
    # Delete veth pair on DOWN
    post-down ip link del br-vlan-veth || true
    bridge_ports br-vlan-veth

# Add an additional address to br-vlan
iface br-external inet static
    # Flat network default gateway
    # -- This needs to exist somewhere for network reachability
    # -- from the router namespace for floating IP paths.
    # -- Putting this here is primarily for tempest to work.
    address {{ host_info[inventory_hostname].VLAN_IP_SECOND }}
    netmask 255.255.252.0

# compute1 VXLAN (tunnel/overlay) bridge config
auto br-tenant
iface br-tenant inet static
    bridge_stp off
    bridge_waitport 0
    bridge_fd 0
    bridge_ports {{ intf_tenant }}
    address {{ host_info[inventory_hostname].VXLAN_IP }}
    netmask 255.255.252.0

# compute storage bridge
auto br-storage
iface br-storage inet static
    bridge_stp off
    bridge_waitport 0
    bridge_fd 0
    bridge_ports {{ intf_storage }}
    address {{ ip_settings[inventory_hostname]["storage"]["ip"] }}
    netmask 255.255.252.0
