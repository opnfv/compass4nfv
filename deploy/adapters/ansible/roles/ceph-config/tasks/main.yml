- name: gen ceph fsid
  shell: uuidgen
  register: ceph_fsid
  run_once: true
  tags:
    - ceph_config

- name: gen ceph conf
  local_action:
    module: "template"
    src: "ceph.j2"
    dest: "/tmp/ceph.conf"
  run_once: true
  tags:
    - ceph_config

- name: install ceph-related packages
  action: "{{ ansible_pkg_mgr }} name={{ item }} state=present"
  with_items:
    - ceph-deploy
  tags:
    - ceph_config

- name: purge ceph
  shell: "ceph-deploy purge {{ inventory_hostname }}; ceph-deploy purgedata {{ inventory_hostname }}; ceph-deploy forgetkeys"
  tags:
    - ceph_config

- name: remove monmap
  file: path="/tmp/monmap" state="absent"
  tags:
    - ceph_config

- name: "make directory for ceph config file"
  file: path="/etc/ceph" state="directory"
  tags:
    - ceph_config

- name: copy ceph conf to dest mon node
  copy: src="/tmp/ceph.conf" dest="/etc/ceph/ceph.conf"
  tags:
    - ceph_config

- name: install ceph-related packages
  action: "{{ ansible_pkg_mgr }} name={{ item }} state=present"
  with_items:
    - ceph
  tags:
    - ceph_config

- include: install_mon.yml
  when: inventory_hostname in groups["ceph_mon"]
  tags:
    - ceph_config

- include: install_osd.yml
  when: inventory_hostname in groups["ceph_osd"]
  tags:
    - ceph_config

- include: ceph_openstack_pre.yml
  tags:
    - ceph_deploy
    - ceph_openstack_pre
    - ceph_openstack

- include: ceph_openstack_conf.yml
  tags:
    - ceph_deploy
    - ceph_openstack_conf
    - ceph_openstack


- meta: flush_handlers
