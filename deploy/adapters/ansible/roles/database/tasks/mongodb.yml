---
- name: install mongodb packages
  action: "{{ ansible_pkg_mgr }} name={{ item }} state=present"
  with_items: mongodb_packages | union(packages_noarch)

- name: install pymongod packages
  pip: name={{ item }} state=present extra_args='--pre'
  with_items: pip_packages

- name: copy ceilometer configs
  template: src=mongodb.conf dest=/opt/os_templates backup=yes

- name: bugfix for centos
  file:
    dest: /var/run/mongo
    state: directory
    owner: mongod
    group: mongod
    mode: 0777
  when: ansible_os_family == "RedHat"

- name: rm data files
  file:
    dest: "{{ item }}"
    state: absent
  with_fileglob:
    - /var/lib/mongodb/journal/*

- name: update mongodb config file
  shell: crudini --merge {{ mongo_config_path }} < /opt/os_templates/mongodb.conf

- name: manually restart mongodb server
  service: name={{ mongodb_serveice }} state=restarted enabled=yes

- wait_for: port=27017 delay=3 timeout=60 host={{ internal_vip.ip }}

- name: create mongodb user
  run_once: True
  mongodb_user:
    login_host: "{{ internal_vip.ip }}"
    database: ceilometer
    name: ceilometer
    password: "{{ CEILOMETER_DBPASS }}"
    roles: 'readWrite,dbAdmin'
    state: present
  when: inventory_hostname == haproxy_hosts.keys()[0]
