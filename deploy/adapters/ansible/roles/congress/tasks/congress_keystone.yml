##############################################################################
# Copyright (c) 2016 HUAWEI TECHNOLOGIES CO.,LTD and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
###############################################################################
---
- name: add service
  shell:
    . /opt/admin-openrc.sh;
    openstack service create \
        --name "{{ item.name }}"
        --description "{{ item.description }}" \
        "{{ item.type }}"
  with_items: "{{ congress_service }}"
  register: result
  until: result.rc == 0
  retries: 10
  delay: 5

- name: add user
  shell:
    . /opt/admin-openrc.sh;
    openstack user create \
        --email "{{ item.email }}" \
        --project "{{ item.tenant }}" \
        --description "{{ item.tenant_description }}" \
        --password "{{ item.password }}" \
        {{ item.user }}
  with_items: "{{ congress_user }}"
  register: result
  until: result.rc == 0
  retries: 10
  delay: 5


- name: grant roles
  shell:
    . /opt/admin-openrc.sh;
    openstack role add \
        --project "{{ item.tenant }}" \
        --user "{{ item.user }}" \
        {{ item.role }}
  with_items: "{{ congress_user }}"
  register: result
  until: result.rc == 0
  retries: 10
  delay: 5

- name: add endpoints
  shell:
    . /opt/admin-openrc.sh;
    openstack endpoint create \
        --region {{ item.region }} \
        {{ item.name }} public {{ item.publicurl }};
    openstack endpoint create \
        --region {{ item.region }} \
        {{ item.name }} internal {{ item.internalurl }};
    openstack endpoint create \
        --region {{ item.region }} \
        {{ item.name }} admin {{ item.adminurl }};
  with_items: "{{ congress_service }}"
  register: result
  until: result.rc == 0
  retries: 10
  delay: 5
