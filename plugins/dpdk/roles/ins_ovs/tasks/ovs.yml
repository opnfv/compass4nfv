##############################################################################
# Copyright (c) 2017 HUAWEI TECHNOLOGIES CO.,LTD and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################
---
- name: create work directory
  file:
    path: "{{ work_dir }}"
    state: directory
    mode: 0755

- name: decompress open-vswitch source
  unarchive:
    src: "{{ ovs_pkg_url }}"
    dest: "{{ work_dir }}"
    remote_src: True

- name: install prerequisites package
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - libnuma-dev
    - dh-autoreconf
    - python-pip

- name: install prerequisites package
  pip:
    name: six

- name: make ovs
  shell: |
    export OVS_DIR={{ work_dir }}/openvswitch-2.7.2
    export DPDK_DIR={{ work_dir }}/dpdk-stable-16.11.2
    export DPDK_TARGET=x86_64-native-linuxapp-gcc
    export DPDK_BUILD=$DPDK_DIR/$DPDK_TARGET

    cd $OVS_DIR

    ./boot.sh
    ./configure --with-dpdk=$DPDK_BUILD  --with-linux=/lib/modules/$(uname -r)/build

    make -j 8
    make install
    sudo mkdir -p /usr/local/etc/openvswitch
    sudo ovsdb-tool create /usr/local/etc/openvswitch/conf.db vswitchd/vswitch.ovsschema

    sudo mkdir -p /usr/local/var/run/openvswitch
    sudo ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock \
        --remote=db:Open_vSwitch,Open_vSwitch,manager_options \
        --pidfile --detach --log-file
