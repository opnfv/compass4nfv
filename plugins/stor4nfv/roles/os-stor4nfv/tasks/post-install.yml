# #############################################################################
# Copyright (c) 2018 Intel Corp.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
# #############################################################################
---

- name: ensure osdsctl exists
  stat:
    path: /opt/opensds-linux-amd64/bin/osdsctl
  ignore_errors: "true"
  register: osdsctl_exists

- name: create opensds default profile, csi pods
  remote_user: root
  shell: |
    cp /opt/opensds-linux-amd64/bin/osdsctl /usr/local/bin;
    export OPENSDS_ENDPOINT=http://{{ public_vip.ip }}:50040;
    export OPENSDS_AUTH_STRATEGY=noauth;
    osdsctl profile create '{"name": "default", "description": "default policy"}'
  ignore_errors: "true"
  when:
    - osdsctl_exists.stat.exists is defined and osdsctl_exists.stat.exists

- name: install cinder-compatible-api
  remote_user: root
  shell: |
    source /etc/profile;
    cd $GOPATH/src/github.com/opensds/opensds;
    go build -o \
        ./build/out/bin/cindercompatibleapi github.com/opensds/opensds/contrib/cindercompatibleapi
  ignore_errors: "true"
  when:
    - osdsctl_exists.stat.exists is defined and osdsctl_exists.stat.exists
  register: cindercompatibleapi_exists

- name: run cinder-compatible-api
  remote_user: root
  shell: |
    export CINDER_ENDPOINT=http://{{ internal_vip.ip }}:8776/v3
    ( ( nohup ./build/out/bin/cindercompatibleapi > /tmp/cindercompatibleapi.log 2>&1 ) & )
  when:
    - cindercompatibleapi_exists.stat.exists is defined and cindercompatibleapi_exists.stat.exists
